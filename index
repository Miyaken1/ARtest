<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ & ARä½“é¨“</title>
  <!-- Instascan (QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
  <!-- A-Frame ã¨ AR.js (ARè¡¨ç¤ºç”¨) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.3.0/aframe-ar.js"></script>
  <!-- æŒ¯å‹•APIã®ãƒãƒªãƒ•ã‚£ãƒ« -->
  <script src="https://cdn.jsdelivr.net/npm/vibration-api-polyfill@1.0.0/dist/vibrate.min.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: Arial, sans-serif; 
      overflow: hidden;
    }
    /* QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #scanner-container { 
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 10;
      background-color: #000;
      transition: opacity 0.3s ease;
    }
    #preview { 
      width: 100%; 
      height: 100%;
      object-fit: cover;
    }
    /* ã‚¹ã‚­ãƒ£ãƒ³ç¯„å›²ã‚’ç¤ºã™ã‚¬ã‚¤ãƒ‰ */
    #scan-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5);
      z-index: 11;
    }
    #scan-guide::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 30px;
      height: 30px;
      border-top: 4px solid #3498db;
      border-left: 4px solid #3498db;
      border-radius: 5px 0 0 0;
    }
    #scan-guide::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 30px;
      height: 30px;
      border-bottom: 4px solid #3498db;
      border-right: 4px solid #3498db;
      border-radius: 0 0 5px 0;
    }
    /* ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    #scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #3498db;
      animation: scan 2s linear infinite;
      z-index: 12;
    }
    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }
    #scan-message {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px;
      font-size: 1.2rem;
      z-index: 11;
    }
    #error-message {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      background-color: rgba(255, 0, 0, 0.7);
      padding: 10px;
      font-size: 1.2rem;
      z-index: 11;
      display: none;
    }
    /* ARè¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #ar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 5;
      display: none;
    }
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border: 8px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
      z-index: 15;
      display: none;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #loading-message {
      position: fixed;
      top: calc(50% + 50px);
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 1.2rem;
      z-index: 15;
      display: none;
    }
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
    .control-button {
      position: absolute;
      z-index: 20;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }
    .control-button:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    #back-button {
      top: 20px;
      left: 20px;
      display: none;
    }
    #camera-switch {
      bottom: 20px;
      right: 20px;
    }
    #resolution-toggle {
      bottom: 20px;
      left: 20px;
    }
    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æƒ…å ± */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    /* ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ« */
    @media (orientation: landscape) {
      #scan-guide {
        width: 200px;
        height: 200px;
      }
      #scan-message {
        top: 10px;
        font-size: 1rem;
      }
      .control-button {
        width: 50px;
        height: 50px;
      }
    }
    /* é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ */
    .high-contrast {
      filter: contrast(1.5);
    }
    /* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼é€šçŸ¥ */
    #network-error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 30;
      display: none;
    }
    #network-error button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã‚¨ãƒªã‚¢ -->
  <div id="scanner-container" role="region" aria-label="QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼">
    <video id="preview" aria-hidden="true"></video>
    <div id="scan-guide">
      <div id="scan-line"></div>
    </div>
    <div id="scan-message" aria-live="polite">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
    <div id="error-message" aria-live="assertive"></div>
    <button id="camera-switch" class="control-button" aria-label="ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">
      <span aria-hidden="true">ğŸ“·</span>
    </button>
    <button id="resolution-toggle" class="control-button" aria-label="è§£åƒåº¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">
      <span aria-hidden="true">ğŸ”</span>
    </button>
    <button id="accessibility-toggle" class="control-button" style="top: 20px; right: 20px;" aria-label="é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">
      <span aria-hidden="true">ğŸ‘ï¸</span>
    </button>
  </div>
  
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div id="loading-indicator" aria-hidden="true"></div>
  <div id="loading-message" aria-live="polite"></div>

  <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼é€šçŸ¥ -->
  <div id="network-error" role="alert">
    <p>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
    <p>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
    <button id="retry-button">å†è©¦è¡Œ</button>
  </div>

  <!-- ARè¡¨ç¤ºç”¨ã‚¨ãƒªã‚¢ -->
  <div id="ar-container" role="region" aria-label="ARä½“é¨“">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" renderer="antialias: true; alpha: true; precision: mediump;">
      <a-entity id="ar-content"></a-entity>
      <a-entity camera></a-entity>
    </a-scene>
    <button id="back-button" class="control-button" aria-label="ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«æˆ»ã‚‹">
      <span aria-hidden="true">â†©</span>
    </button>
  </div>

  <script>
    // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ false ã«è¨­å®šï¼‰
    const DEV_MODE = true;
    
    // è¨±å¯ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
    const ALLOWED_DOMAINS = [
      'example.com',
      'yourdomain.com',
      'ar-models.com'
    ];

    // DOMè¦ç´ ã®å–å¾—
    const scannerContainer = document.getElementById('scanner-container');
    const previewElement = document.getElementById('preview');
    const errorMessage = document.getElementById('error-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingMessage = document.getElementById('loading-message');
    const arContainer = document.getElementById('ar-container');
    const scanMessage = document.getElementById('scan-message');
    const backButton = document.getElementById('back-button');
    const cameraSwitch = document.getElementById('camera-switch');
    const resolutionToggle = document.getElementById('resolution-toggle');
    const accessibilityToggle = document.getElementById('accessibility-toggle');
    const networkError = document.getElementById('network-error');
    const retryButton = document.getElementById('retry-button');
    const arContent = document.getElementById('ar-content');
    const arScene = document.querySelector('a-scene');

    // çŠ¶æ…‹å¤‰æ•°
    let currentCamera = 0;
    let availableCameras = [];
    let isHighResolution = false;
    let isHighContrast = false;
    let scanner = null;
    let lastScannedContent = null;
    let arContentCache = {};

    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
    if (DEV_MODE) {
      arScene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: true;');
      console.log('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™');
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
    function showError(msg, solution = '', duration = 5000) {
      errorMessage.innerHTML = `<strong>${msg}</strong>${solution ? `<br>${solution}` : ''}`;
      errorMessage.style.display = 'block';
      
      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã«ARIAãƒ©ã‚¤ãƒ–ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
      errorMessage.setAttribute('aria-hidden', 'false');
      
      if (duration > 0) {
        setTimeout(() => {
          errorMessage.style.display = 'none';
          errorMessage.setAttribute('aria-hidden', 'true');
        }, duration);
      }
      
      if (DEV_MODE) {
        console.error(msg);
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨é–¢æ•°
    function showLoading(msg = 'ãƒ­ãƒ¼ãƒ‰ä¸­...') {
      loadingIndicator.style.display = 'block';
      loadingMessage.textContent = msg;
      loadingMessage.style.display = 'block';
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºç”¨é–¢æ•°
    function hideLoading() {
      loadingIndicator.style.display = 'none';
      loadingMessage.style.display = 'none';
    }

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨é–¢æ•°
    function showNetworkError() {
      networkError.style.display = 'block';
    }

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼éè¡¨ç¤ºç”¨é–¢æ•°
    function hideNetworkError() {
      networkError.style.display = 'none';
    }

    // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’æ¤œè¨¼ã™ã‚‹é–¢æ•°
    function validateQRContent(content) {
      // URLã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      try {
        const url = new URL(content);
        
        // ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ãƒã‚§ãƒƒã‚¯
        const domain = url.hostname;
        if (!ALLOWED_DOMAINS.some(allowedDomain => domain === allowedDomain || domain.endsWith('.' + allowedDomain))) {
          return {
            isValid: false,
            reason: 'è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã™',
            content: null
          };
        }
        
        return {
          isValid: true,
          reason: '',
          content: content
        };
      } catch (e) {
        // URLã§ãªã„å ´åˆã¯ã€å®‰å…¨ãªæ–‡å­—åˆ—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        // æ½œåœ¨çš„ã«å±é™ºãªã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã§ã„ãªã„ã‹ç¢ºèª
        if (content.includes('<script>') || content.includes('javascript:')) {
          return {
            isValid: false,
            reason: 'ä¸æ­£ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ã¾ã™',
            content: null
          };
        }
        
        // å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯JSONã¨ã—ã¦æ‰±ã†
        return {
          isValid: true,
          reason: '',
          content: content
        };
      }
    }

    // ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
    async function loadARContent(content) {
      showLoading('ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
      
      try {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚‹ã‹ç¢ºèª
        if (arContentCache[content]) {
          renderARContent(arContentCache[content]);
          return;
        }
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†
        if (content.startsWith('http')) {
          // URLã®å ´åˆã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
          const modelUrl = content;
          
          // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª
          if (!navigator.onLine) {
            throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“');
          }
          
          // ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆä¾‹: GLTFãƒ¢ãƒ‡ãƒ«ï¼‰
          const entity = document.createElement('a-entity');
          entity.setAttribute('gltf-model', modelUrl);
          entity.setAttribute('position', '0 0 -1');
          entity.setAttribute('rotation', '0 0 0');
          entity.setAttribute('scale', '0.5 0.5 0.5');
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          arContentCache[content] = entity;
          
          renderARContent(entity);
        } else {
          // ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯JSONã®å ´åˆ
          try {
            // JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
            const data = JSON.parse(content);
            
            // JSONã®å†…å®¹ã«å¿œã˜ãŸARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
            const entity = document.createElement('a-entity');
            
            if (data.type === 'text') {
              // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
              entity.setAttribute('text', {
                value: data.value,
                color: data.color || '#FFF',
                width: data.width || 2,
                align: 'center'
              });
              entity.setAttribute('position', '0 0 -1');
            } else if (data.type === 'model') {
              // ãƒ¢ãƒ‡ãƒ«è¡¨ç¤º
              entity.setAttribute('gltf-model', data.url);
              entity.setAttribute('position', data.position || '0 0 -1');
              entity.setAttribute('rotation', data.rotation || '0 0 0');
              entity.setAttribute('scale', data.scale || '0.5 0.5 0.5');
            }
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            arContentCache[content] = entity;
            
            renderARContent(entity);
          } catch (e) {
            // å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤º
            const entity = document.createElement('a-entity');
            entity.setAttribute('text', {
              value: content,
              color: '#FFF',
              width: 2,
              align: 'center'
            });
            entity.setAttribute('position', '0 0 -1');
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            arContentCache[content] = entity;
            
            renderARContent(entity);
          }
        }
      } catch (error) {
        console.error('ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        
        if (!navigator.onLine || error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
          showNetworkError();
        } else {
          showError('ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'QRã‚³ãƒ¼ãƒ‰ã‚’å†ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„');
          // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«æˆ»ã‚‹
          setTimeout(() => {
            goBackToScanner();
          }, 3000);
        }
      } finally {
        hideLoading();
      }
    }

    // ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
    function renderARContent(entity) {
      // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
      while (arContent.firstChild) {
        arContent.removeChild(arContent.firstChild);
      }
      
      // æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ 
      arContent.appendChild(entity);
      
      // ARç”»é¢ã‚’è¡¨ç¤º
      scannerContainer.style.opacity = 0;
      setTimeout(() => {
        scannerContainer.style.display = 'none';
        arContainer.style.display = 'block';
        backButton.style.display = 'flex';
      }, 300);
    }

    // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«æˆ»ã‚‹é–¢æ•°
    function goBackToScanner() {
      // ARç”»é¢ã‚’éè¡¨ç¤º
      arContainer.style.display = 'none';
      backButton.style.display = 'none';
      
      // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã‚’è¡¨ç¤º
      scannerContainer.style.display = 'block';
      setTimeout(() => {
        scannerContainer.style.opacity = 1;
      }, 10);
      
      // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’å†é–‹
      startScanner();
    }

    // ã‚«ãƒ¡ãƒ©ã‚’å®Œå…¨ã«åœæ­¢ã™ã‚‹é–¢æ•°
    function stopCamera() {
      if (scanner) {
        scanner.stop();
        
        // ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚‚åœæ­¢
        const videoTracks = previewElement.srcObject?.getVideoTracks();
        if (videoTracks && videoTracks.length > 0) {
          videoTracks.forEach(track => track.stop());
        }
        previewElement.srcObject = null;
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    function startScanner() {
      // æ—¢å­˜ã®ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãŒã‚ã‚Œã°åœæ­¢
      stopCamera();
      
      showLoading('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...');
      
      // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®è¨­å®š
      scanner = new Instascan.Scanner({
        video: previewElement,
        mirror: false,
        backgroundScan: false,
        scanPeriod: 3  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã‚¹ã‚­ãƒ£ãƒ³é–“éš”ã‚’èª¿æ•´
      });
      
      // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ™‚ã®å‡¦ç†
      scanner.addListener('scan', function(content) {
        // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
        
        // éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        const beep = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADwADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD////AwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAAABBTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUXQQAB9AAAAcAhkZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=');
        beep.play();
        
        // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’æ¤œè¨¼
        const validationResult = validateQRContent(content);
        
        if (!validationResult.isValid) {
          showError('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™', validationResult.reason);
          return;
        }
        
        // åŒã˜QRã‚³ãƒ¼ãƒ‰ã®é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã‚’é˜²æ­¢
        if (lastScannedContent === validationResult.content) {
          return;
        }
        lastScannedContent = validationResult.content;
        
        if (DEV_MODE) {
          console.log("QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹:", validationResult.content);
        }
        
        // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åœæ­¢
        stopCamera();
        
        // ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰
        loadARContent(validationResult.content);
      });
      
      // ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦é–‹å§‹
      selectAndStartCamera();
    }

    // ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦é–‹å§‹ã™ã‚‹é–¢æ•°
    function selectAndStartCamera() {
      Instascan.Camera.getCameras().then(function(cameras) {
        availableCameras = cameras;
        
        if (cameras.length === 0) {
          showError('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
          hideLoading();
          return;
        }
        
        // é©åˆ‡ãªã‚«ãƒ¡ãƒ©ã‚’é¸æŠ
        let selectedCamera = cameras[currentCamera % cameras.length];
        
        // ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆçš„ã«é¸æŠï¼ˆåˆå›ã®ã¿ï¼‰
        if (currentCamera === 0) {
          // ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã®æ¤œå‡ºæ–¹æ³•ã‚’å¼·åŒ–
          const backCameraKeywords = ['back', 'rear', 'environment', 'å¾Œé¢', 'ãƒãƒƒã‚¯', 'èƒŒé¢'];
          
          for (let i = 0; i < cameras.length; i++) {
            const camera = cameras[i];
            
            // ã‚«ãƒ¡ãƒ©åã¾ãŸã¯ãƒ©ãƒ™ãƒ«ã§ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã‚’æ¤œå‡º
            if (camera.name && backCameraKeywords.some(keyword => camera.name.toLowerCase().includes(keyword))) {
              selectedCamera = camera;
              currentCamera = i;
              break;
            }
            
            // facingMode ãŒ environment ãªã‚‰ãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©
            if (camera.facingMode === 'environment') {
              selectedCamera = camera;
              currentCamera = i;
              break;
            }
          }
        }
        
        // ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹
        scanner.start(selectedCamera).then(() => {
          hideLoading();
          scanMessage.textContent = 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„';
        }).catch(function(error) {
          console.error("ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
          
          if (error.name === 'NotAllowedError') {
            showError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 0);
          } else if (error.name === 'NotFoundError') {
            showError('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
          } else {
            showError('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„: ' + error.message);
          }
          
          hideLoading();
        });
      }).catch(function(e) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        showError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 0);
        hideLoading();
      });
    }

    // ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function switchCamera() {
      if (availableCameras.length <= 1) {
        showError('åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentCamera = (currentCamera + 1) % availableCameras.length;
      showLoading('ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆä¸­...');
      
      // ã‚«ãƒ¡ãƒ©ã‚’å†èµ·å‹•
      selectAndStartCamera();
    }

    // è§£åƒåº¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function toggleResolution() {
      isHighResolution = !isHighResolution;
      
      if (scanner) {
        // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®è¨­å®šã‚’æ›´æ–°
        scanner.stop();
        
        if (isHighResolution) {
          scanner = new Instascan.Scanner({
            video: previewElement,
            mirror: false,
            backgroundScan: false,
            scanPeriod: 5,  // é«˜è§£åƒåº¦ã§ã¯å‡¦ç†ãŒé‡ããªã‚‹ãŸã‚é–“éš”ã‚’é•·ã
            resolution: 1080  // é«˜è§£åƒåº¦
          });
          showError('é«˜è§£åƒåº¦ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', '', 2000);
        } else {
          scanner = new Instascan.Scanner({
            video: previewElement,
            mirror: false,
            backgroundScan: false,
            scanPeriod: 3,
            resolution: 480  // æ¨™æº–è§£åƒåº¦
          });
          showError('æ¨™æº–è§£åƒåº¦ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', '', 2000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
        scanner.addListener('scan', function(content) {
          // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          if (navigator.vibrate) {
            navigator.vibrate(200);
          }
          
          // éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          const beep = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADwADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD////AwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAAABBTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUXQQAB9AAAAcAhkZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=');
          beep.play();
          
          // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’æ¤œè¨¼
          const validationResult = validateQRContent(content);
          
          if (!validationResult.isValid) {
            showError('ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™', validationResult.reason);
            return;
          }
          
          // åŒã˜QRã‚³ãƒ¼ãƒ‰ã®é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã‚’é˜²æ­¢
          if (lastScannedContent === validationResult.content) {
            return;
          }
          lastScannedContent = validationResult.content;
          
          if (DEV_MODE) {
            console.log("QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹:", validationResult.content);
          }
          
          // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åœæ­¢
          stopCamera();
          
          // ARã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰
          loadARContent(validationResult.content);
        });
        
        // ã‚«ãƒ¡ãƒ©ã‚’å†èµ·å‹•
        selectAndStartCamera();
      }
    }

    // é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function toggleHighContrast() {
      isHighContrast = !isHighContrast;
      
      if (isHighContrast) {
        document.body.classList.add('high-contrast');
        showError('é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ', '', 2000);
      } else {
        document.body.classList.remove('high-contrast');
        showError('é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ', '', 2000);
      }
    }

    // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã®å¤‰æ›´ã‚’æ¤œå‡º
    window.addEventListener('orientationchange', function() {
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª¿æ•´
      setTimeout(() => {
        // ARã‚·ãƒ¼ãƒ³ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
        if (arScene) {
          arScene.resize();
        }
      }, 300);
    });

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ¤œå‡º
    window.addEventListener('offline', function() {
      showError('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    });

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ¤œå‡º
    window.addEventListener('online', function() {
      showError('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ', '', 2000);
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    backButton.addEventListener('click', goBackToScanner);
    cameraSwitch.addEventListener('click', switchCamera);
    resolutionToggle.addEventListener('click', toggleResolution);
    accessibilityToggle.addEventListener('click', toggleHighContrast);
    retryButton.addEventListener('click', function() {
      hideNetworkError();
      loadARContent(lastScannedContent);
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®ã‚µãƒãƒ¼ãƒˆ
    document.addEventListener('keydown', function(e) {
      // Escã‚­ãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«æˆ»ã‚‹
      if (e.key === 'Escape' && arContainer.style.display === 'block') {
        goBackToScanner();
      }
      
      // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
      if (e.key === ' ' && scannerContainer.style.display !== 'none') {
        switchCamera();
      }
    });

    // åˆæœŸåŒ–
    window.addEventListener('load', function() {
      // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’é–‹å§‹
      startScanner();
      
      // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚µãƒãƒ¼ãƒˆï¼‰
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
          if (DEV_MODE) {
            console.log('ServiceWorkerç™»éŒ²æˆåŠŸ:', registration.scope);
          }
        }).catch(function(error) {
          console.error('ServiceWorkerç™»éŒ²å¤±æ•—:', error);
        });
      }
    });
  </script>
</body>
</html>
